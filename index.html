<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="js/react.js"></script>
        <script src="js/JSXTransformer.js"></script>
        <script src="js/reflux.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/main.css">
    </head>
    <body>
        <div id="form"></div>
        <div id="svg"></div>

        <script type="text/jsx">
            var topLineUpdate = Reflux.createAction();
            var bottomLineUpdate = Reflux.createAction();

            var linesStore = Reflux.createStore({
                init: function() {
                    this.listenTo(topLineUpdate, this.topLineUpdated);
                    this.listenTo(bottomLineUpdate, this.bottomLineUpdated);
                },
                topLineUpdated: function(value) {
                    this.trigger(value);
                },
                bottomLineUpdated: function(value) {
                    this.trigger(value);
                }

            });

            var MeasurementsForm = React.createClass({
                setTopLine: function(event) {
                    topLineUpdate(event.target.value);
                },
                setBottomLine: function(event) {
                    bottomLineUpdate(event.target.value);
                },
                render: function() {
                    return <form>
                                <input type="text" pattern= "[0-9]" placeholder="Cт" onChange={this.setTopLine} />
                                <input type="text" placeholder="Ди" onChange={this.setBottomLine} />
                           </form>
                }
            });

            var Rectangle = React.createClass({
                render: function() {
                    return <rect {...this.props}>{this.props.children}</rect>;
                }
            });

            var Line = React.createClass({
                render: function() {
                    return <line {...this.props}>{this.props.children}</line>;
                }
            });

            var SVGComponent = React.createClass({
                render: function() {
                    return <svg {...this.props}>{this.props.children}</svg>;
                }
            });

            var Pattern = React.createClass({
                render: function() {
                    return <pattern {...this.props}>{this.props.children}</pattern>;
                }
            });

            var Path = React.createClass({
                render: function() {
                    return <path {...this.props}>{this.props.children}</path>
                }
            });

            var TopLine = React.createClass({
                getInitialState: function(){
                    return { length: 0 };
                },
                componentDidMount: function() {
                    linesStore.listen(this.drowLine);
                },
                drowLine: function(value) {
                    value = 0.64 * (+value + 1) * 10;
                    this.setState({ length: "M " + value + " 0 Q " + value + " " + value + " 0 " + value });
                },
                render: function() {
                    return (
                        <path d={this.state.length} stroke="blue" stroke-width="5" fill="transparent"></path>
                    )
                }
            });

            var Lines = React.createClass({
                getInitialState: function(){
                    return { lines: [] };
                },
                componentDidMount: function() {
                    linesStore.listenTo(topLineUpdate, this.drowLine);
                    linesStore.listenTo(bottomLineUpdate, this.drowLine);
                },
                drowLine: function(value) {
                    value = 0.64 * (+value + 1) * 10;
                    var length = "M " + value + " 0 Q " + value + " " + value + " 0 " + value;
                    this.setState({ lines: this.state.lines.concat({length: length }) });
                },
                render: function() {
                    var lines = this.state.lines.map(function(p){
                        return <path d={p.length} stroke="blue" stroke-width="5" fill="transparent"></path>
                    });

                    return (
                        <g>
                        {lines}
                        </g>
                    )
                }
            });


            var Grid = React.createClass({
                render: function() {
                    return  <SVGComponent height="100%" width="100%">
                                <text x="-20" y="-10">O</text>
                                <Lines />
                                <Pattern id="smallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
                                    <Path d="M 10 0 L 0 0 0 10" fill="none" stroke="gray" stroke-width="0.5" />
                                </Pattern>
                                <Pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
                                    <Rectangle width="100" height="100" fill="url(#smallGrid)"/>
                                    <Path d="M 100 0 L 0 0 0 100" fill="none" stroke="gray" stroke-width="1"/>
                                </Pattern>

                                <Rectangle width="100%" height="100%" fill="url(#grid)" />
                            </SVGComponent>
                }
            });


            React.render(
                <MeasurementsForm />,
                document.getElementById('form')
            );

            React.render(
                <Grid />,
                document.getElementById('svg')
            )
        </script>
    </body>
</html>